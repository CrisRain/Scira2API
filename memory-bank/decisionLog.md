# 决策日志

本文档记录了项目生命周期中所做的关键决策。

## YYYY-MM-DD
### 决策：[决策简述]
*   **背景：** [为什么需要这个决策]
*   **考虑的选项：** [简要列出替代方案]
*   **推理：** [为什么选择了该选项]
*   **影响：** [预期的结果或后果]
*   **相关方：** [涉及或受影响的人员]

---

## 2025-05-23
### 决策：在`service/utils.go#processContent`中采用带手动回退的`strconv.Unquote`处理字符串转义字符。
*   **背景：** 现有的`processContent`中的转义字符处理比较基础（仅处理`\\n`和修剪引号），需要更加健壮和全面。
*   **考虑的选项：**
    1.  纯手动替换，使用`strings.ReplaceAll`处理扩展的转义序列列表。
    2.  使用`strconv.Unquote`作为主要方法。
    3.  混合方法：`strconv.Unquote`优先，辅以手动替换作为回退。
*   **推理：** 选择了混合方法（选项3）。`strconv.Unquote`是Go标准库处理所有Go定义的转义序列的健壮方式。提供回退机制（手动替换常见的转义字符如`\\`、`\"`、`\n`、`\t`、`\r`以及引号修剪）确保即使`strconv.Unquote`失败（例如，由于非标准输入或格式错误的序列），该函数仍然能够在常见情况下可预测地运行并满足原始需求。这在健壮性和优雅降级之间取得了平衡。
*   **影响：** 改进了字符串内容处理的正确性和可靠性。`processContent`函数现在能够处理更广泛的转义输入。
*   **相关方：** 开发团队，任何依赖`processContent`进行字符串清理或解释的系统组件。
*   **参考：** 详细实现和推理记录在2025-05-23代码模式执行子任务期间的`memory-bank/activeContext.md`中。

---

## 2025-05-23
### 决策：为API响应添加完整的tokens统计功能
*   **背景：** 现有系统中的非流式响应已有tokens统计功能，但流式响应中缺少此功能。为了保持API响应的一致性和提供完整的使用数据，需要在流式响应中也添加tokens统计。
*   **考虑的选项：**
    1.  保持现状，仅在非流式响应中提供tokens统计。
    2.  为流式响应开发与非流式响应不同的tokens统计机制。
    3.  统一tokens统计结构，在所有类型响应中使用相同的数据结构和处理逻辑。
*   **推理：** 选择了选项3。统一的tokens统计结构可以保持API响应的一致性，简化客户端的处理逻辑。通过在ChatHandler中添加streamUsage字段来存储流式响应过程中的统计数据，并在最终响应中包含这些数据，实现了与非流式响应相同的功能。同时更新了Usage结构体，添加了更详细的统计字段（如InputTokensDetails和OutputTokensDetails），使得tokens统计更加全面。
*   **影响：** 
    1. 提高了API响应的一致性，无论是流式还是非流式响应都能提供完整的tokens统计。
    2. 增强了API的可用性，客户端可以更准确地了解资源使用情况。
    3. 为未来可能的计费或使用限制功能提供了基础。
*   **相关方：** 开发团队，API的使用者，可能的监控或计费系统。

---